@inject IStringLocalizer<Resource> Localizer
@inject IHomeViewModel ViewModel
@inject IPositionService PositionService
@inject IJSRuntime JsRuntime
@implements IDisposable

<div class="d-flex flex-column">
    <div class="d-flex justify-content-between mb-6">
        <LocationHome Model="@this.Model"></LocationHome>
        <LocationSearch ModelChanged="@this.SelectLocation"></LocationSearch>
    </div>
</div>

<WeatherHome Location="@this.Model"></WeatherHome>
<AirPollutionHome Location="@this.Model"></AirPollutionHome>

@code
    {
    private bool? LocalizationIsAvailable { get; set; } = null;

    private LocationModel Model { get; set; } = new LocationModel();

    protected override async Task OnInitializedAsync()
    {
        #if DEBUG
        await Task.Delay(5000);
        #endif

        if (this.ViewModel != null)
        {
            await this.ViewModel.InitializeAsync(null);
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if ((this.ViewModel != null) && (this.PositionService != null))
        {
            await this.PositionService.GetCurrentPosition(JsRuntime, GetPositionAsync, GetErrorAsync);
        }
    }

    private async Task GetErrorAsync(string error)
    {
        this.Model.LocalizationIsAvailable = await Task.FromResult<bool>(false);        

        //Warning don't delete this line
        this.StateHasChanged();
    }

    private async Task GetPositionAsync(double longitude, double latitude)
    {
        this.Model.Longitude = Math.Round(longitude,6);
        this.Model.Latitude = Math.Round(latitude,6);
        this.Model.LocalizationIsAvailable = await Task.FromResult<bool>(true);

        //Warning don't delete this line
        this.StateHasChanged();
    }

    public void Dispose()
    {
        this.ViewModel?.Dispose();
    }

    private void SelectLocation(LocationModel model)
    {
        this.Model = model;
    }
}
